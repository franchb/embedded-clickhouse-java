name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: {}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5.0.1

      - name: Compile
        run: ./gradlew assemble

      - name: Verify bytecode versions
        run: |
          verify_bytecode() {
            local module="$1"
            local expected="$2"
            local label="$3"
            local dir="$module/build/classes/java/main"
            if [ ! -d "$dir" ]; then
              echo "SKIP $module (no classes)"
              return 0
            fi
            local bad=0
            while IFS= read -r -d '' classfile; do
              major=$(javap -verbose "$classfile" 2>/dev/null | grep 'major version' | awk '{print $NF}')
              if [ -n "$major" ] && [ "$major" -ne "$expected" ]; then
                echo "FAIL $classfile: major=$major expected=$expected ($label)"
                bad=1
              fi
            done < <(find "$dir" -name '*.class' -print0)
            if [ "$bad" -eq 0 ]; then
              echo "OK   $module â€” all classes are $label (major version $expected)"
            fi
            return $bad
          }

          failed=0
          verify_bytecode embedded-clickhouse           52 "Java 8"  || failed=1
          verify_bytecode embedded-clickhouse-junit4     52 "Java 8"  || failed=1
          verify_bytecode embedded-clickhouse-junit5     52 "Java 8"  || failed=1
          verify_bytecode embedded-clickhouse-spring-boot 61 "Java 17" || failed=1
          exit $failed

      - name: Check Gradle wrapper
        uses: gradle/actions/wrapper-validation@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5.0.1

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    permissions:
      contents: read
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5.0.1

      - name: Run unit tests
        run: ./gradlew test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-results-${{ matrix.os }}
          path: '**/build/reports/tests/'
          retention-days: 7

  integration-test:
    name: Integration Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    permissions:
      contents: read
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5.0.1

      - name: Cache ClickHouse binary
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/embedded-clickhouse
          key: clickhouse-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('**/ClickHouseVersion.java') }}

      - name: Run integration tests
        run: ./gradlew :embedded-clickhouse:integrationTest

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: integration-test-results-${{ matrix.os }}
          path: '**/build/reports/tests/integrationTest/'
          retention-days: 7
